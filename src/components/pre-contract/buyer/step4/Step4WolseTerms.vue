<template>
  <div class="space-y-6">
    <!-- 월세 자금 대출 -->
    <ToggleRadio
      v-model="loanPlan"
      label="월세 자금 대출을 계획하고 계신가요?"
      :options="[
        { label: '예', value: true },
        { label: '아니요', value: false },
      ]"
    />

    <!-- 월세 보증 보험 가입 -->
    <ToggleRadio
      v-model="insurancePlan"
      label="월세 연체에 대비한 보증 보험 가입을 계획하고 계신가요?"
      :options="[
        { label: '예', value: true },
        { label: '아니요', value: false },
      ]"
    />

    <!-- 입주 예정일 -->
    <div>
      <BaseInput
        v-model="moveInDate"
        type="date"
        label="입주 예정일을 선택해주세요"
        class="w-full"
      />
    </div>

    <!-- 계약 기간 -->
    <div class="space-y-2">
      <ToggleRadio
        v-model="contractDuration"
        label="계약 기간을 선택해주세요"
        :options="[
          { label: '1년', value: 'YEAR_1' },
          { label: '2년', value: 'YEAR_2' },
          { label: '2년 이상', value: 'YEAR_OVER_2' },
        ]"
      />
    </div>

    <!-- 재계약 의사 -->
    <ToggleRadio
      v-model="renewalIntent"
      label="재계약(갱신) 의사가 있으신가요?"
      :options="[
        { label: '있음', value: '있음' },
        { label: '없음', value: '없음' },
        { label: '미정', value: '미정' },
      ]"
    />
  </div>
  <BaseButton @click="updateTenantStep1"> 테스트 버튼 </BaseButton>
</template>

<script setup>
import { ref, onMounted, watch } from 'vue'
import ToggleRadio from '@/components/common/ToggleRadio.vue'
import BaseInput from '@/components/common/BaseInput.vue'
import { usePreContractStore } from '@/stores/preContract'
import buyerApi from '@/apis/pre-contract-buyer.js'
import { useRoute } from 'vue-router'

const store = usePreContractStore()

const route = useRoute()
const contractChatId = route.params.id

onMounted(async () => {
  store.canProceed = false
  try {
    const { data } = await buyerApi.selectTenantStep1(contractChatId)

    loanPlan.value = data.loanPlan
    insurancePlan.value = data.insurancePlan
    moveInDate.value = data.moveInDate
    contractDuration.value = data.contractDuration
    renewalIntent.value = data.renewalIntent
  } catch (error) {
    console.error('step1 조회 실패 ❌', error)
  }
})

const loanPlan = ref(null)
const insurancePlan = ref(null)
const moveInDate = ref('')
const contractDuration = ref('')
const renewalIntent = ref('')

watch(
  [loanPlan, insurancePlan, moveInDate, contractDuration, renewalIntent],
  ([loan, insurance, moveIn, contract, renewal]) => {
    const allFilled =
      loan !== null && insurance !== null && moveIn !== '' && contract !== '' && renewal !== ''
    store.setCanProceed(allFilled)
  },
)

const updateTenantStep1 = async () => {
  const step1DTO = {
    loanPlan: loanPlan.value,
    insurancePlan: insurancePlan.value,
    expectedMoveInDate: moveInDate.value,
    contractDuration: contractDuration.value,
    renewalIntent: renewalIntent.value,
  }

  try {
    await buyerApi.updateTenantStep1(contractChatId, step1DTO)
    alert('Step1 월세 정보가 저장되었습니다! ✅')
  } catch (error) {
    // API 파일에서 에러를 받아서 사용자에게 알리거나 UI 반응을 주는 게 목적 👉 사용자에게 UI 반응(알림, 메시지 등)을 주기 위한 처리
    console.error('step1 월세 저장 실패 ❌', error)
  }
}
</script>
